<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>采集管道仪表盘</title>
    <link rel="stylesheet" href="/public/styles.css" />
  </head>
  <body>
    <header>
      <h1>采集与处理管道</h1>
      <% if (message) { %>
        <p class="message"><%= message %></p>
      <% } %>
    </header>

    <section class="actions">
      <div class="card">
        <h2>运行采集</h2>
        <form method="post" action="/run">
          <fieldset>
            <legend>选择站点</legend>
            <% config.targets.forEach((target) => { %>
              <label class="checkbox">
                <input type="checkbox" name="targets" value="<%= target.slug %>" />
                <span><%= target.name %> (<%= target.slug %>)</span>
              </label>
            <% }) %>
          </fieldset>
          <div class="options">
            <label>
              <input type="checkbox" name="skipAi" />
              跳过本地 AI 识别
            </label>
            <label>
              <input type="checkbox" name="skipUpload" />
              跳过 COS 上传
            </label>
          </div>
          <button type="submit">开始运行</button>
        </form>
      </div>
      <div class="card">
        <h2>仅上传到 COS</h2>
        <form method="post" action="/upload">
          <p>跳过采集与 AI，上传所有未上传的图片到腾讯云 COS。</p>
          <button type="submit">执行上传</button>
        </form>
      </div>
    </section>

    <section class="stats">
      <h2>数据概览</h2>
      <ul>
        <li>记录总数：<strong><%= stats.total %></strong></li>
        <li>待上传：<strong><%= stats.pendingUpload %></strong></li>
        <li>已完成 AI 标签：<strong><%= stats.withAi %></strong></li>
      </ul>
    </section>

    <section>
      <h2>最新处理记录</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>来源</th>
              <th>标题</th>
              <th>标签</th>
              <th>颜色</th>
              <th>描述</th>
              <th>预览</th>
              <th>上传状态</th>
            </tr>
          </thead>
          <tbody>
            <% if (records.length === 0) { %>
              <tr>
                <td colspan="8" class="empty">暂无数据</td>
              </tr>
            <% } %>
            <% records.forEach((record) => { %>
              <tr>
                <td><code><%= record.id %></code></td>
                <td><%= targetNames.get(record.target.slug) || record.target.slug %></td>
                <td><%= record.title || '-' %></td>
                <td>
                  <% if (record.aiTags && record.aiTags.length > 0) { %>
                    <span class="tag-list"><%= record.aiTags.join(', ') %></span>
                  <% } else if (record.tags && record.tags.length > 0) { %>
                    <span class="tag-list"><%= record.tags.join(', ') %></span>
                  <% } else { %>
                    -
                  <% } %>
                </td>
                <td>
                  <% if (record.aiColors && record.aiColors.length > 0) { %>
                    <div class="color-swatches">
                      <% record.aiColors.forEach((color) => { %>
                        <span class="swatch" style="--color:<%= color %>" title="<%= color %>"></span>
                      <% }) %>
                    </div>
                  <% } else { %>
                    -
                  <% } %>
                </td>
                <td><%= record.aiCaption || record.description || '-' %></td>
                <td>
                  <% if (record.compressedPath || record.localPath) { %>
                    <img src="/preview?path=<%= encodeURIComponent(record.compressedPath || record.localPath) %>" alt="预览" />
                  <% } else { %>
                    -
                  <% } %>
                </td>
                <td>
                  <% if (record.remoteUrl) { %>
                    <a href="<%= record.remoteUrl %>" target="_blank" rel="noopener">已上传</a>
                  <% } else { %>
                    待上传
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </section>
  </body>
</html>
